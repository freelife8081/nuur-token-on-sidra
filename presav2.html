<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NUUR Coin Presale</title>

  <!-- Bulma CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <style>
    body {
      background-color: #0d111c;
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    .box {
      background-color: #1a1e2d;
      width: 100%;
      max-width: 400px;
      border-radius: 1rem;
    }
    .input,
    .button {
      border-radius: 1rem;
    }
    .button.is-green {
      background-color: #22c55e;
      color: white;
    }
    .button.is-green:hover {
      background-color: #16a34a;
      color: white;
    }
    .tag.is-info {
      background-color: #3b82f6;
    }
    #spinner {
      border: 3px solid rgba(255, 255, 255, 0.25);
      border-top-color: #22c55e;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: auto;
      margin-top: 1rem;
      display: none;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .token-logo {
      height: 24px;
      width: 24px;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="box">
    <div class="level">
      <div class="level-left">
        <h1 class="title is-4">NUUR Presale Phase 2</h1>
      </div>
      <div class="level-right">
        <button id="connectWalletButton" class="button is-info">Connect Wallet</button>
        <button id="disconnectWalletButton" class="button is-light" style="display:none;">
          Disconnect
        </button>
      </div>
    </div>

    <div class="field">
      <label class="label" for="sdaAmount">
        <span class="icon">
          <img src="sidra.png" alt="SDA" class="token-logo" />
        </span>
        Amount (SDA)
      </label>
      <div class="control has-icons-left">
        <input
          id="sdaAmount"
          class="input"
          type="number"
          step="any"
          min="0"
          placeholder="0.00"
        />
        <span class="icon is-small is-left">SDA</span>
      </div>
    </div>

    <div class="field">
      <label class="label" for="nuurEstimate">
        <span class="icon">
          <img src="logo.png" alt="NUUR" class="token-logo" />
        </span>
        Estimated NUUR
      </label>
      <div class="control">
        <input
          id="nuurEstimate"
          class="input"
          type="text"
          readonly
          value="0"
        />
      </div>
    </div>

    <div class="content is-small" style="color:#bbb; margin-bottom: 1rem;">
      <p><strong>Phase:</strong> NuurPhase2</p>
      <p><strong>Rate:</strong> 1 SDA = 200 NUUR (1 NUUR = 0.005 SDA)</p>
      <p>
        <strong>Min Buy:</strong> <span id="minBuyText">1</span> SDA
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <strong>Max Buy:</strong> <span id="maxBuyText">Loading...</span> SDA
      </p>
    </div>

    <button id="buyButton" class="button is-green is-fullwidth" disabled>Buy NUUR</button>

    <div id="spinner"></div>

    <p
      id="statusMessage"
      class="has-text-centered mt-3"
      style="min-height: 1.2em;"
    ></p>

    <hr style="border-color: #2a2f45;" />

    <div class="content is-small has-text-centered" style="color:#bbb;">
      <p>
        Wallet:
        <span id="walletAddress">Not Connected</span>
      </p>
      <p>
        Balance:
        <span id="walletBalance">N/A</span>
      </p>
    </div>
  </div>

  <script>
    // === Config ===
    const presaleAddress = "0x98FCc396547D450208e926995a74b61874a1423A"; // Replace with your contract
    const presaleABI = [{"inputs":[{"internalType":"address","name":"_nuurToken","type":"address"},{"internalType":"address","name":"_devWallet","type":"address"},{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"newDevWallet","type":"address"}],"name":"DevWalletUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"NUURWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"phaseId","type":"uint256"},{"indexed":false,"internalType":"string","name":"phaseName","type":"string"},{"indexed":false,"internalType":"uint256","name":"rate","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"PhaseUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"isActive","type":"bool"}],"name":"PresaleStatusChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"SDAWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"sdaAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nuurAmount","type":"uint256"},{"indexed":false,"internalType":"string","name":"phaseName","type":"string"},{"indexed":false,"internalType":"uint256","name":"rate","type":"uint256"}],"name":"TokensPurchased","type":"event"},{"inputs":[],"name":"buyTokens","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"sdaAmount","type":"uint256"}],"name":"calculateNUURAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentPhaseId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentPhaseName","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"devWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentPhaseInfo","outputs":[{"internalType":"uint256","name":"phaseId","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"rate","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"tokensSold","type":"uint256"},{"internalType":"uint256","name":"sdaReceived","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getNUURBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"phaseId","type":"uint256"}],"name":"getPhaseInfo","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"rate","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"tokensSold","type":"uint256"},{"internalType":"uint256","name":"sdaReceived","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSDABalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nuurToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"phaseStartTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"phases","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"rate","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"tokensSold","type":"uint256"},{"internalType":"uint256","name":"sdaReceived","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"presaleActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_status","type":"bool"}],"name":"setPresaleStatus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalSDAReceived","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalTokensSold","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newDevWallet","type":"address"}],"name":"updateDevWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newPhaseId","type":"uint256"},{"internalType":"string","name":"newPhaseName","type":"string"},{"internalType":"uint256","name":"newRate","type":"uint256"}],"name":"updatePhase","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawNUUR","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawSDA","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
    const nuurPrice = 0.005; // 1 NUUR = 0.005 SDA
    const minBuy = 1; // Updated minimum buy

    // === State ===
    let web3,
      userAddress,
      presaleContract,
      maxBuy = 0;

    // === Elements ===
    const connectBtn = document.getElementById("connectWalletButton");
    const disconnectBtn = document.getElementById("disconnectWalletButton");
    const buyBtn = document.getElementById("buyButton");
    const sdaInput = document.getElementById("sdaAmount");
    const nuurEstimate = document.getElementById("nuurEstimate");
    const statusMessage = document.getElementById("statusMessage");
    const spinner = document.getElementById("spinner");
    const walletAddressSpan = document.getElementById("walletAddress");
    const walletBalanceSpan = document.getElementById("walletBalance");
    const minBuyText = document.getElementById("minBuyText");
    const maxBuyText = document.getElementById("maxBuyText");

    minBuyText.innerText = minBuy;

    // Initialize web3 and contract
    async function init() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        presaleContract = new web3.eth.Contract(presaleABI, presaleAddress);
      } else {
        alert("Please install MetaMask!");
      }
    }

    async function connectWallet() {
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        userAddress = accounts[0];
        walletAddressSpan.innerText =
          userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
        connectBtn.style.display = "none";
        disconnectBtn.style.display = "inline-block";
        statusMessage.innerText = "Wallet connected.";
        await updateWalletBalance();
        await updateMaxBuy();
        enforceInputBounds();
        buyBtn.disabled = false;
      } catch (error) {
        console.error(error);
        statusMessage.innerText = "Failed to connect wallet.";
      }
    }

    function disconnectWallet() {
      userAddress = null;
      walletAddressSpan.innerText = "Not Connected";
      walletBalanceSpan.innerText = "N/A";
      connectBtn.style.display = "inline-block";
      disconnectBtn.style.display = "none";
      statusMessage.innerText = "Wallet disconnected.";
      sdaInput.value = "";
      nuurEstimate.value = "0";
      maxBuyText.innerText = "Loading...";
      maxBuy = 0;
      buyBtn.disabled = true;
    }

    async function updateWalletBalance() {
      if (!userAddress) {
        walletBalanceSpan.innerText = "N/A";
        return;
      }
      try {
        const balanceWei = await web3.eth.getBalance(userAddress);
        const balance = web3.utils.fromWei(balanceWei, "ether");
        walletBalanceSpan.innerText = parseFloat(balance).toFixed(4) + " SDA";
      } catch (e) {
        walletBalanceSpan.innerText = "Error";
      }
    }

    async function updateMaxBuy() {
      if (!presaleContract) {
        maxBuyText.innerText = "Contract not loaded";
        return;
      }
      try {
        const tokensLeftRaw = await presaleContract.methods.tokensLeft().call();
        // tokensLeftRaw is uint256 with 18 decimals, convert to number
        const tokensLeft = parseFloat(web3.utils.fromWei(tokensLeftRaw, "ether"));
        maxBuy = tokensLeft * nuurPrice;
        maxBuyText.innerText = maxBuy.toFixed(4);
        enforceInputBounds();
      } catch (e) {
        maxBuyText.innerText = "Error";
        console.error("Error fetching tokensLeft:", e);
      }
    }

    function enforceInputBounds() {
      let val = parseFloat(sdaInput.value || 0);
      if (val < minBuy) {
        sdaInput.value = minBuy;
        val = minBuy;
      }
      if (maxBuy > 0 && val > maxBuy) {
        sdaInput.value = maxBuy.toFixed(4);
        val = maxBuy;
      }
      updateEstimate(val);
    }

    function updateEstimate(sdaAmount) {
      if (!sdaAmount || sdaAmount < minBuy) {
        nuurEstimate.value = "0";
        return;
      }
      if (maxBuy > 0 && sdaAmount > maxBuy) {
        sdaAmount = maxBuy;
      }
      const nuurAmount = Math.floor(sdaAmount / nuurPrice);
      nuurEstimate.value = nuurAmount.toLocaleString();
    }

    sdaInput.addEventListener("input", (e) => {
      let val = parseFloat(e.target.value);
      if (isNaN(val)) val = 0;
      updateEstimate(val);
    });

    sdaInput.addEventListener("blur", enforceInputBounds);

    buyBtn.addEventListener("click", async () => {
      if (!userAddress) {
        alert("Please connect wallet first");
        return;
      }

      let amount = parseFloat(sdaInput.value);
      if (isNaN(amount) || amount < minBuy) {
        alert(`Minimum buy is ${minBuy} SDA`);
        return;
      }
      if (maxBuy > 0 && amount > maxBuy) {
        alert(`Maximum buy is ${maxBuy.toFixed(4)} SDA`);
        return;
      }

      try {
        spinner.style.display = "block";
        statusMessage.innerText = "Sending transaction...";
        const receipt = await web3.eth.sendTransaction({
          from: userAddress,
          to: presaleAddress,
          value: web3.utils.toWei(amount.toString(), "ether"),
        });
        spinner.style.display = "none";

        const explorerBase = "https://ledger.sidrachain.com/tx/"; // Replace with your actual explorer URL
        const txLink = `<a href="${explorerBase}${receipt.transactionHash}" target="_blank" rel="noopener" style="color:#22c55e; text-decoration: underline;">View on ledger</a>`;

        statusMessage.innerHTML = `Transaction successful! ${txLink}`;
        await updateWalletBalance();
        await updateMaxBuy();
        sdaInput.value = "";
        nuurEstimate.value = "0";
      } catch (e) {
        spinner.style.display = "none";
        statusMessage.innerText = "Transaction failed or rejected.";
        console.error(e);
      }
    });

    connectBtn.addEventListener("click", connectWallet);
    disconnectBtn.addEventListener("click", disconnectWallet);

    // Initialize
    init();

    // Auto-connect if already connected
    window.ethereum
      ?.request({ method: "eth_accounts" })
      .then((accounts) => {
        if (accounts.length > 0) {
          connectWallet();
        }
      });

    // Update balance and address if accounts change
    window.ethereum?.on("accountsChanged", (accounts) => {
      if (accounts.length === 0) {
        disconnectWallet();
      } else {
        userAddress = accounts[0];
        walletAddressSpan.innerText =
          userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
        updateWalletBalance();
      }
    });
  </script>
</body>
</html>
