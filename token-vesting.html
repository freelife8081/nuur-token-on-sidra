<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuur Vesting — New UI</title>

  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    /* ---------- Basic reset ---------- */
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#94a3b8;
      --accent:#7c3aed;
      --accent-2:#06b6d4;
      --glass: rgba(255,255,255,0.03);
      --success:#16a34a;
      --danger:#ef4444;
      --card-radius:14px;
      --shadow: 0 8px 30px rgba(2,6,23,0.7);
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{background:linear-gradient(180deg,var(--bg) 0%, #071022 100%); color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; display:flex; align-items:center; justify-content:center; padding:28px;}

    /* ---------- App container ---------- */
    .app {
      width:100%;
      max-width:var(--maxw);
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:24px;
      align-items:start;
    }

    /* ---------- Sidebar ---------- */
    .sidebar {
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.03);
      min-height:520px;
    }
    .brand {
      display:flex; gap:12px; align-items:center; margin-bottom:18px;
    }
    .brand .logo {
      width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;
      box-shadow:0 6px 20px rgba(124,58,237,0.18);
    }
    .brand h1{font-size:18px;margin:0}
    .connect-cta{margin-top:14px}
    .btn {
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600;
    }
    .btn-primary{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; box-shadow:0 8px 28px rgba(7,11,26,0.6); }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }

    .small { font-size:13px; color:var(--muted) }

    .sidebar .section { margin-top:18px }
    .sidebar .card {
      background:var(--panel);
      border-radius:12px; padding:12px; margin-top:10px; border:1px solid rgba(255,255,255,0.02)
    }

    /* ---------- Main ---------- */
    .main {
      min-height:520px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--card-radius);
      padding:20px;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.03);
      display:flex; flex-direction:column;
    }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .panel {
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius:12px; padding:16px; border:1px solid rgba(255,255,255,0.02);
    }
    .panel h3{margin:0 0 10px 0; font-size:14px; color:var(--muted)}
    .big-value{ font-size:22px; font-weight:700; color:linear-gradient(90deg,var(--accent),#fff); }

    /* progress */
    .progress-wrap{height:14px;background:rgba(255,255,255,0.03); border-radius:10px; overflow:hidden; margin-top:12px}
    .progress-bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); box-shadow:0 8px 30px rgba(10,30,80,0.2); transition:width 650ms ease}

    /* Claim area */
    .claim-area{ margin-top:18px; display:flex; gap:12px; align-items:center; justify-content:flex-start }
    .claim-amount{ font-size:20px; font-weight:800; color:var(--accent-2) }

    /* Timer */
    .countdown { display:flex; gap:8px; margin-top:12px }
    .countdown .unit { background:rgba(255,255,255,0.03); padding:8px 10px; border-radius:8px; min-width:58px; text-align:center }
    .unit .num { font-weight:800; font-size:16px; color:var(--accent) }
    .unit .lbl { font-size:11px; color:var(--muted); text-transform:uppercase; }

    /* Admin modal */
    .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.6); z-index:60; }
    .modal { width:calc(100% - 48px); max-width:880px; background:var(--panel); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.02) }
    .modal .row { display:flex; gap:12px; }
    .form-input{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit }

    /* notifications */
    .toast { position:fixed; right:26px; top:26px; background:#071025; padding:12px 16px; border-radius:10px; border-left:4px solid var(--success); box-shadow:0 10px 30px rgba(2,6,23,0.6); display:flex; gap:10px; align-items:center; z-index:80; color:#e6eef8 }

    /* tiny helpers */
    .muted { color:var(--muted); font-size:13px }
    a.link { color:var(--accent-2); text-decoration:none; font-weight:600 }
    .hidden { display:none !important }

    /* responsive */
    @media (max-width:950px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ order:2 }
      .main{ order:1 }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Nuur vesting app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">NUUR</div>
        <div>
          <h1>Nuur Vesting</h1>
          <div class="small">Token migration & claims</div>
        </div>
      </div>

      <!-- Connect CTA (visible always) -->
      <div class="connect-cta" id="ctaContainer">
        <div class="small muted">To start, connect your wallet</div>
        <div style="margin-top:12px;">
          <button class="btn btn-primary" id="connectBtn"><svg width="14" height="14" style="transform:translateY(-1px)"><path fill="white" d="M2 2h10v10H2z"/></svg> Connect Wallet</button>
        </div>
      </div>

      <!-- Account quick info (hidden until connected) -->
      <div id="accountBox" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Connected</div>
            <div id="addrShort" style="font-weight:700">0x--</div>
          </div>
          <div>
            <div class="muted">Network</div>
            <div id="chainLabel" style="font-weight:700">Sidra</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="muted">Balances</div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div>
              <div class="muted">NUUR</div>
              <div id="nuurBal" style="font-weight:800">0.00</div>
            </div>
            <div>
              <div class="muted">SDA</div>
              <div id="sdaBal" style="font-weight:800">0.00</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="muted">KYC</div>
          <div style="margin-top:8px"><span id="kycDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--danger);margin-right:8px"></span><span id="kycText">Not verified</span></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn btn-ghost" id="refreshBtnSmall">Refresh</button>
          <button class="btn btn-ghost hidden" id="adminBtnSmall">Admin</button>
        </div>
      </div>

      <div class="section">
        <div class="muted">Notes</div>
        <div class="small" style="margin-top:8px"> Please make sure you participated in presale and KYC verified.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="mainArea">
      <!-- Before connect -->
      <div id="welcome" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; padding:40px 20px;">
        <h2 style="margin:0;font-size:20px">Welcome to Nuur Vesting</h2>
        <p class="muted" style="max-width:720px; text-align:center">Connect your wallet to view your allocation and claim vested tokens.</p>
        <div>
          <button class="btn btn-primary" id="connectBtn2">Connect Wallet</button>
        </div>
      </div>

      <!-- App content (hidden until connected) -->
      <div id="appContent" class="hidden" aria-hidden="true" style="width:100%">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h2 style="margin:0">Dashboard</h2>
            <div class="muted" style="margin-top:6px">Overview of your vesting and claim status</div>
          </div>

          <div style="display:flex;align-items:center;gap:12px">
            <div class="muted">Contract:</div>
            <a id="contractLink" class="link" href="#" target="_blank" rel="noopener">View on explorer</a>
            <button id="openAdmin" class="btn btn-ghost hidden">Admin</button>
            <button id="disconnectBtn" class="btn btn-ghost">Disconnect</button>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="grid-2">
          <div class="panel">
            <h3>Allocation</h3>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="muted">Total allocated (old token + presales)</div>
                <div id="allocated" class="big-value" style="margin-top:8px">0 NUUR</div>
              </div>
              <div style="text-align:right">
                <div class="muted">Claimed</div>
                <div id="claimed" style="font-weight:800; margin-top:8px">0 NUUR</div>
              </div>
            </div>

            <div class="progress-wrap" style="margin-top:14px">
              <div class="progress-bar" id="progressBar" style="width:0%"></div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
              <div class="muted">Months passed</div>
              <div id="monthsPassed" style="font-weight:800">0 / 12</div>
            </div>

            <div class="claim-area">
              <div>
                <div class="muted">Claimable now</div>
                <div class="claim-amount" id="claimableDisplay">0 NUUR</div>
              </div>

              <div style="margin-left:12px">
                <button id="claimBtn" class="btn btn-primary" disabled>Claim</button>
              </div>
            </div>

            <div class="countdown" id="countdown">
              <div class="unit"><div class="num" id="cdDays">--</div><div class="lbl">Days</div></div>
              <div class="unit"><div class="num" id="cdHours">--</div><div class="lbl">Hours</div></div>
              <div class="unit"><div class="num" id="cdMins">--</div><div class="lbl">Mins</div></div>
              <div class="unit"><div class="num" id="cdSecs">--</div><div class="lbl">Secs</div></div>
            </div>
          </div>

          <div class="panel">
            <h3>Actions</h3>

            <div style="margin-top:10px">
              <div class="muted">Quick actions</div>
              <div style="display:flex;gap:10px;margin-top:8px">
                <button id="refreshBtnLarge" class="btn btn-ghost">Refresh</button>
                <button id="showPresales" class="btn btn-ghost">Presale Contracts</button>
              </div>
            </div>

            <div style="margin-top:16px">
              <div class="muted">Explorer</div>
              <div style="display:flex;gap:10px;margin-top:8px">
                <a id="explorerTx" class="link" href="#" target="_blank" rel="noopener">Last TX</a>
              </div>
            </div>

            <div style="margin-top:16px">
              <div class="muted">Status</div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <div class="muted">Vesting:</div><div id="vestingStatus">Not started</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <div class="muted">Paused:</div><div id="pausedStatus">No</div>
              </div>
            </div>

            <div style="margin-top:16px" id="presaleContainer" class="hidden">
              <div class="muted">Presale contracts</div>
              <div id="presaleList" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:12px; justify-content:flex-end">
          <div class="muted">Deployed vesting</div>
          <div id="contractAddr" style="font-weight:800"></div>
        </div>

      </div>
    </main>
  </div>

  <!-- ADMIN MODAL (hidden) -->
  <div id="adminModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Admin Controls</h3>
        <div style="display:flex;gap:8px">
          <button id="closeAdmin" class="btn btn-ghost">Close</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row" style="gap:14px;">
        <div style="flex:1">
          <label class="muted small">Add single presale</label>
          <input id="adminPresale" class="form-input" placeholder="0x..." />
          <div style="margin-top:8px; display:flex; gap:8px">
            <button id="adminAddPresale" class="btn btn-primary">Add</button>
          </div>

          <div style="height:12px"></div>

          <label class="muted small">Add multiple (comma/newline)</label>
          <textarea id="adminBatch" class="form-input" style="min-height:90px" placeholder="0x..., 0x..."></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="adminBatchAdd" class="btn btn-primary">Add Batch</button>
          </div>
        </div>

        <div style="flex:1">
          <label class="muted small">Set single KYC</label>
          <input id="adminKycAddr" class="form-input" placeholder="0x..." />
          <select id="adminKycStatus" class="form-input" style="margin-top:8px">
            <option value="true">Verified</option>
            <option value="false">Not verified</option>
          </select>
          <div style="margin-top:8px"><button id="adminSetKyc" class="btn btn-primary">Set KYC</button></div>

          <div style="height:12px"></div>

          <label class="muted small">Batch KYC (addresses newline/comma) and statuses (comma)</label>
          <textarea id="adminKycBatchAddrs" class="form-input" style="min-height:80px" placeholder="0x...,0x...,..."></textarea>
          <input id="adminKycBatchStatuses" class="form-input" placeholder="true,false,true" style="margin-top:8px" />
          <div style="margin-top:8px"><button id="adminSetKycBatch" class="btn btn-primary">Set Batch KYC</button></div>

        </div>
      </div>

      <div style="height:16px"></div>

      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button id="adminStart" class="btn btn-primary">Start Vesting</button>
        <button id="adminPause" class="btn btn-ghost">Pause</button>
        <button id="adminUnpause" class="btn btn-ghost">Unpause</button>
      </div>

      <div style="height:12px"></div>

      <div>
        <div class="muted">Presale list</div>
        <div id="adminPresaleList" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- notification area -->
  <div id="toast" class="hidden" role="status" aria-live="polite"></div>

  <script>
  (function(){
    /* ---------- Config (use your addresses) ---------- */
    const CONTRACT_ADDR = "0xF300235899b647bea68122B18Ff7d757e71BE2a2";
    const NUUR_TOKEN = "0x135800ac1DB3Ba26af6c4A95c49b1Ed00F851E57";
    const SIDRA_CHAIN = { chainId: "0x17CAD", blockExplorerUrls:["https://ledger.sidrachain.com"] };
    const EXPLORER = (SIDRA_CHAIN.blockExplorerUrls && SIDRA_CHAIN.blockExplorerUrls[0]) ? SIDRA_CHAIN.blockExplorerUrls[0].replace(/\/$/,'') : '';

    const VESTING_ABI = [{"inputs":[{"internalType":"address","name":"_newToken","type":"address"},{"internalType":"address","name":"_oldToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address[]","name":"users","type":"address[]"},{"indexed":false,"internalType":"bool[]","name":"statuses","type":"bool[]"}],"name":"KYCBatchUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"verified","type":"bool"}],"name":"KYCUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldToken","type":"address"}],"name":"OldTokenSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"presale","type":"address"}],"name":"PresaleContractAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"beneficiary","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensClaimed","type":"event"},{"anonymous":false,"inputs":[],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"VestingStarted","type":"event"},{"inputs":[],"name":"MONTH_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"VESTING_MONTHS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"presale","type":"address"}],"name":"addOldPresaleContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"calculateClaimable","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getClaimableAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOldPresaleContracts","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getTotalPurchase","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserTotalPurchase","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"kycVerified","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"newToken","outputs":[{"internalType":"contract INuurCoin","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"oldPresaleContracts","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"oldToken","outputs":[{"internalType":"contract IOldToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"status","type":"bool"}],"name":"setKYC","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"users","type":"address[]"},{"internalType":"bool[]","name":"statuses","type":"bool[]"}],"name":"setKYCForBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startVesting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"vestingInfo","outputs":[{"internalType":"uint256","name":"totalAmount","type":"uint256"},{"internalType":"uint256","name":"claimedAmount","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"vestingStartTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"vestingStarted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}];

    /* ---------- DOM ---------- */
    const connectBtn = document.getElementById('connectBtn');
    const connectBtn2 = document.getElementById('connectBtn2');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const ctaContainer = document.getElementById('ctaContainer');
    const accountBox = document.getElementById('accountBox');
    const addrShort = document.getElementById('addrShort');
    const chainLabel = document.getElementById('chainLabel');
    const nuurBal = document.getElementById('nuurBal');
    const sdaBal = document.getElementById('sdaBal');
    const kycDot = document.getElementById('kycDot');
    const kycText = document.getElementById('kycText');
    const adminBtnSmall = document.getElementById('adminBtnSmall');

    const welcome = document.getElementById('welcome');
    const appContent = document.getElementById('appContent');
    const mainArea = document.getElementById('mainArea');
    const contractAddr = document.getElementById('contractAddr');
    const contractLink = document.getElementById('contractLink');
    const claimBtn = document.getElementById('claimBtn');
    const allocatedEl = document.getElementById('allocated');
    const claimedEl = document.getElementById('claimed');
    const claimableDisplay = document.getElementById('claimableDisplay');
    const progressBar = document.getElementById('progressBar');
    const monthsPassedEl = document.getElementById('monthsPassed');
    const cdDays = document.getElementById('cdDays');
    const cdHours = document.getElementById('cdHours');
    const cdMins = document.getElementById('cdMins');
    const cdSecs = document.getElementById('cdSecs');
    const vestingStatus = document.getElementById('vestingStatus');
    const pausedStatus = document.getElementById('pausedStatus');
    const showPresales = document.getElementById('showPresales');
    const presaleContainer = document.getElementById('presaleContainer');
    const presaleList = document.getElementById('presaleList');
    const refreshBtnSmall = document.getElementById('refreshBtnSmall');
    const refreshBtnLarge = document.getElementById('refreshBtnLarge');
    const openAdmin = document.getElementById('openAdmin');
    const adminModal = document.getElementById('adminModal');
    const closeAdmin = document.getElementById('closeAdmin');
    const adminBtn = document.getElementById('adminBtnSmall');

    // admin modal elements
    const adminPresale = document.getElementById('adminPresale');
    const adminAddPresale = document.getElementById('adminAddPresale');
    const adminBatch = document.getElementById('adminBatch');
    const adminBatchAdd = document.getElementById('adminBatchAdd');
    const adminKycAddr = document.getElementById('adminKycAddr');
    const adminKycStatus = document.getElementById('adminKycStatus');
    const adminSetKyc = document.getElementById('adminSetKyc');
    const adminKycBatchAddrs = document.getElementById('adminKycBatchAddrs');
    const adminKycBatchStatuses = document.getElementById('adminKycBatchStatuses');
    const adminSetKycBatch = document.getElementById('adminSetKycBatch');
    const adminStart = document.getElementById('adminStart');
    const adminPause = document.getElementById('adminPause');
    const adminUnpause = document.getElementById('adminUnpause');
    const adminPresaleList = document.getElementById('adminPresaleList');

    const toast = document.getElementById('toast');
    const explorerTx = document.getElementById('explorerTx');

    /* ---------- State ---------- */
    let provider = null;
    let signer = null;
    let account = null;
    let contract = null;
    let tokenContract = null;
    let decimals = 18;
    let vestingStartTimeSec = 0;
    let nextVestingTimeMs = null;
    let lastClaimable = ethers.BigNumber.from(0);
    let isOwner = false;
    const POLL_INTERVAL = 15000; // 15s

    /* ---------- util helpers ---------- */
    function toastShow(msg, type='info', link=null){
      toast.className = 'toast';
      toast.innerHTML = `<div>${msg}</div>`;
      if(link) {
        const a = document.createElement('a');
        a.href = link; a.target='_blank'; a.textContent = 'View';
        a.style.marginLeft = '12px'; a.style.color = 'var(--accent-2)';
        toast.appendChild(a);
      }
      setTimeout(()=>{ toast.className = 'hidden'; }, 4200);
    }

    function short(addr){
      if(!addr) return '0x--';
      return addr.slice(0,6)+'…'+addr.slice(-4);
    }

    async function connectWallet(){
      if(!window.ethereum){ toastShow('Please install MetaMask or compatible wallet','error'); return; }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      try {
        await provider.send('eth_requestAccounts',[]);
        signer = provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDR, VESTING_ABI, signer);
        tokenContract = new ethers.Contract(NUUR_TOKEN, ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"], signer);
        // show UI
        ctaContainer.classList.add('hidden');
        accountBox.classList.remove('hidden');
        welcome.style.display='none';
        appContent.classList.remove('hidden'); appContent.setAttribute('aria-hidden','false');
        // set short addr
        addrShort.textContent = short(account);
        try { decimals = await tokenContract.decimals(); } catch(e){ decimals = 18; }
        contractAddr.textContent = CONTRACT_ADDR;
        contractLink.href = EXPLORER ? `${EXPLORER}/address/${CONTRACT_ADDR}` : '#';
        explorerTx.href = EXPLORER ? `${EXPLORER}` : '#';
        // initial load
        await loadAll();
        startPoll();
      } catch (e) {
        console.error(e); toastShow('Wallet connection cancelled or failed','error');
      }
    }

    async function disconnect(){
      // simple disconnect: clear UI and state (wallet providers usually don't allow programmatic disconnect)
      account = null; signer = null; provider = null; contract = null; tokenContract=null;
      ctaContainer.classList.remove('hidden');
      accountBox.classList.add('hidden');
      welcome.style.display='flex';
      appContent.classList.add('hidden'); appContent.setAttribute('aria-hidden','true');
      addrShort.textContent = '0x--';
      toastShow('Disconnected','info');
    }

    async function loadAll(){
      if(!contract || !account) return;
      try {
        // balances
        const [bNu, bSda] = await Promise.all([ tokenContract.balanceOf(account), provider.getBalance(account) ]);
        nuurBal.textContent = ethers.utils.formatUnits(bNu, decimals);
        sdaBal.textContent = ethers.utils.formatEther(bSda);

        // kyc
        const k = await contract.kycVerified(account);
        kycText.textContent = k ? 'Verified' : 'Not verified';
        kycDot.style.background = k ? 'var(--success)' : 'var(--danger)';

        // vesting status
        const [vStarted, paused, vestStartBN] = await Promise.all([ contract.vestingStarted(), contract.paused(), contract.vestingStartTime() ]);
        vestingStartTimeSec = vestStartBN.toNumber();
        vestingStatus.textContent = vStarted ? 'Active' : 'Not started';
        pausedStatus.textContent = paused ? 'Yes' : 'No';

        // purchases/vesting info
        const [totalPurchase, claimable] = await Promise.all([ contract.getTotalPurchase(account), contract.getClaimableAmount(account) ]);
        const vestInfo = await contract.vestingInfo(account);
        const claimed = vestInfo.claimedAmount ? vestInfo.claimedAmount : vestInfo[1];

        allocatedEl.textContent = `${ethers.utils.formatUnits(totalPurchase, decimals)} NUUR`;
        claimedEl.textContent = `${ethers.utils.formatUnits(claimed, decimals)} NUUR`;
        claimableDisplay.textContent = `${ethers.utils.formatUnits(claimable, decimals)} NUUR`;
        lastClaimable = claimable;

        // months passed & progress
        if(vStarted && vestingStartTimeSec > 0){
          const now = Math.floor(Date.now()/1000);
          let months = Math.floor((now - vestingStartTimeSec) / (30*24*60*60));
          if(months < 0) months=0; if(months>12) months=12;
          monthsPassedEl.textContent = `${months} / 12`;
          progressBar.style.width = `${(months/12)*100}%`;
          // next slice
          const nextSec = vestingStartTimeSec + (months+1)*30*24*60*60;
          nextVestingTimeMs = nextSec*1000;
        } else {
          monthsPassedEl.textContent = `0 / 12`;
          progressBar.style.width = `0%`;
          nextVestingTimeMs = null;
        }

        // enable claim button only if KYC true and claimable > 0
        if(k && claimable.gt(0) && !paused) { claimBtn.disabled=false } else { claimBtn.disabled=true }

        // owner check -> show admin
        const owner = await contract.owner().catch(()=>null);
        isOwner = owner && owner.toLowerCase() === account.toLowerCase();
        document.getElementById('adminBtnSmall').style.display = isOwner ? 'inline-block' : 'none';
        document.getElementById('openAdmin').style.display = isOwner ? 'inline-block' : 'none';

        // presales list hidden by default, will show when clicking 'Presale Contracts' or if owner (admin panel shows them)
        presaleContainer.classList.add('hidden');
      } catch (e){
        console.error('loadAll error',e);
        toastShow('Failed to load data from chain','error');
      }
    }

    async function claim(){
      if(!contract || !account) return;
      try {
        toastShow('Submitting claim tx...','info');
        claimBtn.disabled=true; claimBtn.textContent='Processing...';
        const tx = await contract.claim();
        const receipt = await tx.wait();
        const txh = receipt.transactionHash || tx.hash;
        toastShow('Claim successful','success', EXPLORER ? `${EXPLORER}/tx/${txh}` : null);
        // refresh
        await loadAll();
        claimBtn.textContent='Claim';
      } catch (e){
        console.error('claim failed', e);
        toastShow('Claim failed','error');
        claimBtn.disabled=false; claimBtn.textContent='Claim';
      }
    }

    async function loadPresalesToUI(){
      if(!contract) return;
      try {
        const arr = await contract.getOldPresaleContracts();
        presaleList.innerHTML = '';
        if(!arr || arr.length===0){ presaleList.innerHTML = '<div class="muted small">No presales added</div>'; return;}
        presaleContainer.classList.remove('hidden');
        arr.forEach((a,i)=>{
          const el = document.createElement('div');
          el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px 4px';
          const left = document.createElement('a'); left.href = EXPLORER? `${EXPLORER}/address/${a}`:'#'; left.target='_blank'; left.textContent = `${i}: ${a}`; left.style.color='var(--muted)';
          const badge = document.createElement('div'); badge.textContent='onchain'; badge.style.fontSize='12px'; badge.style.color='var(--muted)';
          el.appendChild(left); el.appendChild(badge);
          presaleList.appendChild(el);
        });
      } catch(e){ console.error('presales load',e); toastShow('Failed to load presales','error'); }
    }

    /* ---------- Admin handlers ---------- */
    async function openAdminModal(){
      if(!isOwner) { toastShow('Owner required','error'); return; }
      adminModal.classList.remove('hidden'); adminModal.setAttribute('aria-hidden','false');
      // populate presales
      try {
        const arr = await contract.getOldPresaleContracts();
        adminPresaleList.innerHTML='';
        if(!arr || arr.length===0) adminPresaleList.innerHTML = '<div class="muted small">No presales</div>';
        else arr.forEach((a,i)=>{
          const item = document.createElement('div'); item.style.padding='6px 4px'; item.style.display='flex'; item.style.justifyContent='space-between';
          const link = document.createElement('a'); link.href = EXPLORER?`${EXPLORER}/address/${a}`:'#'; link.target='_blank'; link.textContent = `${i}: ${a}`; link.style.color='var(--muted)';
          item.appendChild(link);
          adminPresaleList.appendChild(item);
        });
      } catch(e){ console.error(e); }
    }
    async function closeAdminModal(){ adminModal.classList.add('hidden'); adminModal.setAttribute('aria-hidden','true'); }

    async function adminAddSingle(){
      const a = adminPresale.value.trim();
      if(!a){ toastShow('Enter address','warning'); return; }
      try{
        if(!confirm(`Add presale: ${a}?`)) return;
        const tx = await contract.addOldPresaleContract(a);
        const receipt = await tx.wait();
        toastShow('Presale added','success', EXPLORER?`${EXPLORER}/tx/${receipt.transactionHash}`:null);
        adminPresale.value='';
        await openAdminModal(); await loadPresalesToUI();
      } catch(e){ console.error(e); toastShow('Failed to add presale','error'); }
    }

    async function adminAddBatch(){
      const raw = adminBatch.value.trim();
      if(!raw){ toastShow('Enter addresses','warning'); return; }
      const arr = raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      if(arr.length===0){ toastShow('No valid addresses','warning'); return; }
      if(!confirm(`Add ${arr.length} presales?`)) return;
      try {
        // try batch
        try {
          const tx = await contract.addOldPresaleContracts(arr);
          const receipt = await tx.wait();
          toastShow('Batch added (single tx)','success', EXPLORER?`${EXPLORER}/tx/${receipt.transactionHash}`:null);
        } catch(e){
          // fallback sequential
          let lastHash=null;
          for(const a of arr){ const tx = await contract.addOldPresaleContract(a); const r = await tx.wait(); lastHash = r.transactionHash || tx.hash; }
          toastShow('Batch added (multiple txs)','success', EXPLORER?`${EXPLORER}/tx/${lastHash}`:null);
        }
        adminBatch.value='';
        await openAdminModal(); await loadPresalesToUI();
      } catch(e){ console.error(e); toastShow('Failed to add batch','error'); }
    }

    async function adminSetKycSingle(){
      const a = adminKycAddr.value.trim(); const s = adminKycStatus.value === 'true';
      if(!a){ toastShow('Enter address','warning'); return; }
      try {
        const tx = await contract.setKYC(a, s);
        const r = await tx.wait();
        toastShow('KYC updated','success', EXPLORER?`${EXPLORER}/tx/${r.transactionHash}`:null);
        adminKycAddr.value='';
        if(a.toLowerCase()===account.toLowerCase()) await loadAll();
      } catch(e){ console.error(e); toastShow('Failed to set KYC','error'); }
    }

    async function adminSetKycBatch(){
      const rawAddrs = adminKycBatchAddrs.value.trim();
      const rawStats = adminKycBatchStatuses.value.trim();
      if(!rawAddrs || !rawStats){ toastShow('Provide both addresses and statuses','warning'); return; }
      const addrs = rawAddrs.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      const stats = rawStats.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean).map(s=> s === 'true');
      if(addrs.length !== stats.length){ toastShow('Length mismatch','warning'); return; }
      if(!confirm(`Set KYC for ${addrs.length} addresses?`)) return;
      try {
        const tx = await contract.setKYCForBatch(addrs, stats);
        const r = await tx.wait();
        toastShow('Batch KYC updated','success', EXPLORER?`${EXPLORER}/tx/${r.transactionHash}`:null);
        adminKycBatchAddrs.value=''; adminKycBatchStatuses.value='';
        await loadAll();
      } catch(e){ console.error(e); toastShow('Failed batch KYC','error'); }
    }

    async function adminStartVesting(){ if(!confirm('Start vesting? This is irreversible.')) return; try{ const tx=await contract.startVesting(); const r = await tx.wait(); toastShow('Vesting started','success', EXPLORER?`${EXPLORER}/tx/${r.transactionHash}`:null); await loadAll(); } catch(e){ console.error(e); toastShow('Failed to start','error'); } }
    async function adminPause(){ if(!confirm('Pause contract?')) return; try{ const tx=await contract.pause(); const r=await tx.wait(); toastShow('Paused','success', EXPLORER?`${EXPLORER}/tx/${r.transactionHash}`:null); await loadAll(); } catch(e){ console.error(e); toastShow('Failed to pause','error'); } }
    async function adminUnpause(){ if(!confirm('Unpause contract?')) return; try{ const tx=await contract.unpause(); const r=await tx.wait(); toastShow('Unpaused','success', EXPLORER?`${EXPLORER}/tx/${r.transactionHash}`:null); await loadAll(); } catch(e){ console.error(e); toastShow('Failed to unpause','error'); } }

    /* ---------- Polling / Timer ---------- */
    let pollHandle = null;
    function startPoll(){ if(pollHandle) clearInterval(pollHandle); pollHandle = setInterval(pollTick, POLL_INTERVAL); }
    async function pollTick(){
      try {
        if(!contract || !account) return;
        const claimable = await contract.getClaimableAmount(account);
        if(claimable.gt(lastClaimable)){
          toastShow('New tokens unlocked — claim available','success');
          lastClaimable = claimable;
          await loadAll();
        }
        // if next vesting passed
        if(nextVestingTimeMs && Date.now() >= nextVestingTimeMs){ await loadAll(); }
      } catch(e){ console.error('pollTick',e); }
    }

    function startCountdown(){
      setInterval(()=>{
        if(!nextVestingTimeMs){ cdDays.textContent='--'; cdHours.textContent='--'; cdMins.textContent='--'; cdSecs.textContent='--'; return; }
        const diff = Math.max(0, nextVestingTimeMs - Date.now());
        if(diff <= 0){ cdDays.textContent='00'; cdHours.textContent='00'; cdMins.textContent='00'; cdSecs.textContent='00'; return; }
        const days = Math.floor(diff/(1000*60*60*24));
        const hours = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
        const mins = Math.floor((diff%(1000*60*60))/(1000*60));
        const secs = Math.floor((diff%(1000*60))/1000);
        cdDays.textContent = String(days).padStart(2,'0');
        cdHours.textContent = String(hours).padStart(2,'0');
        cdMins.textContent = String(mins).padStart(2,'0');
        cdSecs.textContent = String(secs).padStart(2,'0');
      }, 1000);
    }

    /* ---------- UI wiring ---------- */
    connectBtn.addEventListener('click', connectWallet);
    connectBtn2.addEventListener('click', connectWallet);
    disconnectBtn.addEventListener('click', disconnect);
    claimBtn.addEventListener('click', claim);
    showPresales.addEventListener('click', loadPresalesToUI);
    refreshBtnSmall.addEventListener('click', loadAll);
    refreshBtnLarge.addEventListener('click', loadAll);

    // admin
    document.getElementById('adminBtnSmall').addEventListener('click', openAdminModal);
    openAdmin.addEventListener('click', openAdminModal);
    closeAdmin.addEventListener('click', closeAdminModal);
    adminAddPresale.addEventListener('click', adminAddSingle);
    adminBatchAdd.addEventListener('click', adminAddBatch);
    adminSetKyc.addEventListener('click', adminSetKycSingle);
    adminSetKycBatch.addEventListener('click', adminSetKycBatch);
    adminStart.addEventListener('click', adminStartVesting);
    adminPause.addEventListener('click', adminPause);
    adminUnpause.addEventListener('click', adminUnpause);

    // start countdown loop
    startCountdown();

    // small UX: clicking contract link copies address if no explorer
    contractLink.addEventListener('click', (e)=>{
      if(!EXPLORER){ e.preventDefault(); navigator.clipboard && navigator.clipboard.writeText(CONTRACT_ADDR).then(()=> toastShow('Contract address copied','success')); }
    });

    // expose basic error logging
    window.addEventListener('error', (ev)=> console.warn('page error', ev.error));
  })();
  </script>
</body>
</html>
