<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>NUUR Presale</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-white min-h-screen flex flex-col justify-center px-4 relative">
  <!-- Wallet Buttons at Top Right -->
  <div class="absolute top-4 right-4 space-x-2 flex">
    <button id="connectWalletButton" onclick="connectWallet()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
      Connect Wallet
    </button>
    <button id="disconnectWalletButton" onclick="disconnectWallet()" style="display: none;"
            class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transition">
      Disconnect Wallet
    </button>
  </div>

  <!-- Main Content -->
  <div class="max-w-sm w-full bg-gray-800/90 backdrop-blur-md shadow-lg rounded-lg p-6 space-y-6 mx-auto mt-20">
    <div class="text-center">
      <img src="logo.png" alt="NUUR Logo" class="mx-auto h-16 w-16 mb-4"/>
      <h1 class="text-3xl font-extrabold tracking-wide">NUUR Coin Presale</h1>
      <p class="text-sm text-gray-300 mt-2">1 NUUR = 0.001 SDA | 1000 NUUR per SDA</p>
    </div>

    <div class="text-center">
      <p class="text-base text-gray-200 font-medium">Remaining NUUR available for purchase:</p>
      <p id="contractBalance" class="text-xl font-bold text-yellow-400 mt-2">Loading...</p>
    </div>

    <div class="text-center">
      <p class="text-base text-gray-200 font-medium">Your Wallet Balances:</p>
      <p id="walletBalance" class="text-lg font-bold text-green-400 mt-2">Not Connected</p>
      <p id="nuurBalance" class="text-lg font-bold text-blue-400 mt-2">Not Connected</p>
    </div>

    <div>
      <label for="sdaAmount" class="block text-sm font-medium mb-2">Enter SDA Amount:</label>
      <input id="sdaAmount" type="number" min="0.001" max="5000" step="0.001" placeholder="e.g. 10"
             class="w-full px-4 py-3 text-sm rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
      <p class="mt-2 text-sm text-gray-300">You'll receive <span id="nuurEstimate" class="font-semibold text-yellow-400">0</span> NUUR</p>
    </div>

    <!-- Dynamic Sections -->
    <div id="connectedFeatures" style="display: none;">
      <div>
        <p class="text-base text-gray-200 font-medium">Gas Fee Estimate:</p>
        <p id="gasFee" class="text-lg font-bold text-red-400 mt-2">Calculating...</p>
      </div>

      <div>
        <p class="text-base text-gray-200 font-medium">Recent Transactions:</p>
        <ul id="transactionHistory" class="text-sm text-gray-300 space-y-2">
          <li>Loading...</li>
        </ul>
      </div>
    </div>

    <div id="statusMessage" class="text-sm text-center mt-4 text-yellow-400"></div>
  </div>

  <script>
    let userAddress;
    const presaleAddress = "0x858024C3c8179Ed448A9133190f991cfA9873657"; // Replace with your Presale contract address
    const nuurTokenAddress = "0x003BEc2e6ef4369f9d968eCD288d31B59fD9c2CD"; // Replace with your NUUR token contract address
    const rate = 1000;

    // Placeholders for ABIs
    const presaleAbi = [{"inputs":[{"internalType":"address","name":"_nuurToken","type":"address"},{"internalType":"address","name":"_devWallet","type":"address"},{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"NUURWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"SDAWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"sdaAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nuurAmount","type":"uint256"}],"name":"TokensPurchased","type":"event"},{"inputs":[],"name":"RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyTokens","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"devWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nuurToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newDevWallet","type":"address"}],"name":"updateDevWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawNUUR","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawSDA","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]; 

    const tokenAbi = [{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"ERC1363ApproveFailed","type":"error"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC1363InvalidReceiver","type":"error"},{"inputs":[{"internalType":"address","name":"spender","type":"address"}],"name":"ERC1363InvalidSpender","type":"error"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"ERC1363TransferFailed","type":"error"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"ERC1363TransferFromFailed","type":"error"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"allowance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"}],"name":"ERC20InsufficientAllowance","type":"error"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"}],"name":"ERC20InsufficientBalance","type":"error"},{"inputs":[{"internalType":"address","name":"approver","type":"address"}],"name":"ERC20InvalidApprover","type":"error"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC20InvalidReceiver","type":"error"},{"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"ERC20InvalidSender","type":"error"},{"inputs":[{"internalType":"address","name":"spender","type":"address"}],"name":"ERC20InvalidSpender","type":"error"},{"inputs":[],"name":"EnforcedPause","type":"error"},{"inputs":[],"name":"ExpectedPause","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approveAndCall","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"approveAndCall","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"burnFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferAndCall","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"transferAndCall","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"transferFromAndCall","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFromAndCall","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const provider = window.ethereum;

    async function connectWallet() {
      if (!provider) return alert("Please install MetaMask!");

      try {
        const accounts = await provider.request({ method: "eth_requestAccounts" });
        userAddress = accounts[0];

        document.getElementById("statusMessage").innerText = `Wallet Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
        document.getElementById("connectWalletButton").style.display = "none";
        document.getElementById("disconnectWalletButton").style.display = "inline-block";

        // Show connected features
        document.getElementById("connectedFeatures").style.display = "block";

        await showContractBalance();
        await showWalletBalances();
        await estimateGasFee();
        await fetchTransactionHistory();
      } catch {
        document.getElementById("statusMessage").innerText = "Wallet connection failed.";
      }
    }

    async function disconnectWallet() {
      userAddress = null;
      document.getElementById("statusMessage").innerText = "Wallet disconnected.";
      document.getElementById("connectWalletButton").style.display = "inline-block";
      document.getElementById("disconnectWalletButton").style.display = "none";

      document.getElementById("connectedFeatures").style.display = "none"; // Hide connected features
      document.getElementById("walletBalance").innerText = "Not Connected";
      document.getElementById("nuurBalance").innerText = "Not Connected";
    }

    async function showWalletBalances() {
      if (!provider || !userAddress) return;

      const web3 = new window.Web3(provider);
      try {
        // Fetch native coin balance
        const balance = await web3.eth.getBalance(userAddress);
        const formattedBalance = parseFloat(web3.utils.fromWei(balance, "ether")).toFixed(4);
        document.getElementById("walletBalance").innerText = `${formattedBalance} SDA`;

        // Fetch NUUR token balance
        const nuurContract = new web3.eth.Contract(tokenAbi, nuurTokenAddress);
        const decimals = await nuurContract.methods.decimals().call();
        const nuurBalance = await nuurContract.methods.balanceOf(userAddress).call();
        const formattedNuurBalance = parseFloat(nuurBalance / Math.pow(10, decimals)).toFixed(2);
        document.getElementById("nuurBalance").innerText = `${formattedNuurBalance} NUUR`;
      } catch {
        document.getElementById("walletBalance").innerText = "Unavailable";
        document.getElementById("nuurBalance").innerText = "Unavailable";
      }
    }

    async function estimateGasFee() {
      if (!provider || !userAddress) return;

      const web3 = new window.Web3(provider);
      try {
        const gasPrice = await web3.eth.getGasPrice(); // Fetch current gas price
        const estimatedGas = 21000; // Typical gas limit for simple transfers
        const gasFee = web3.utils.fromWei((gasPrice * estimatedGas).toString(), "ether");
        document.getElementById("gasFee").innerText = `${parseFloat(gasFee).toFixed(6)} SDA`;
      } catch {
        document.getElementById("gasFee").innerText = "Unavailable";
      }
    }

    async function fetchTransactionHistory() {
      if (!provider || !userAddress) return;

      const web3 = new window.Web3(provider);
      try {
        const latestBlock = await web3.eth.getBlockNumber();
        const txHistory = [];
        for (let i = latestBlock; i >= latestBlock - 10; i--) {
          const block = await web3.eth.getBlock(i, true);
          block.transactions.forEach((tx) => {
            if (tx.from.toLowerCase() === userAddress.toLowerCase() || tx.to?.toLowerCase() === userAddress.toLowerCase()) {
              txHistory.push(tx);
            }
          });
        }

        const txList = txHistory.map(
          (tx) =>
            `<li>Tx Hash: <a href="https://ledger.sidrachain.com/tx/${tx.hash}" target="_blank" class="text-yellow-300">${tx.hash.slice(0, 10)}...</a>
             | Value: ${web3.utils.fromWei(tx.value, "ether")} SDA</li>`
        );
        document.getElementById("transactionHistory").innerHTML = txList.join("");
      } catch {
        document.getElementById("transactionHistory").innerHTML = "<li>Unavailable</li>";
      }
    }

    document.getElementById("sdaAmount").addEventListener("input", function () {
      const sda = parseFloat(this.value || "0");
      document.getElementById("nuurEstimate").innerText = sda * rate;
    });

    async function showContractBalance() {
      if (!provider) return;
      const web3 = new window.Web3(provider);
      const contract = new web3.eth.Contract(presaleAbi, presaleAddress);

      try {
        const nuur = await contract.methods.nuurToken().call();
        const nuurContract = new web3.eth.Contract(tokenAbi, nuur);

        const decimals = await nuurContract.methods.decimals().call();
        const balance = await nuurContract.methods.balanceOf(presaleAddress).call();
        const formatted = parseFloat(balance / Math.pow(10, decimals)).toLocaleString();

        document.getElementById("contractBalance").innerText = formatted;
      } catch {
        document.getElementById("contractBalance").innerText = "Unavailable";
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</body>
</html>
