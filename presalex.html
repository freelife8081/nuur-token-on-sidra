<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>NUUR Presale | Sidra Chain</title>
  <link rel="icon" href="logo.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-white min-h-screen flex flex-col justify-center px-4 relative">
  <!-- Wallet Buttons at Top Right -->
  <div class="absolute top-4 right-4 space-x-2 flex">
    <button id="connectWalletButton" onclick="connectWallet()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
      Connect Wallet
    </button>
    <button id="disconnectWalletButton" onclick="disconnectWallet()" style="display: none;"
            class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transition">
      Disconnect Wallet
    </button>
  </div>

  <!-- Main Content -->
  <div class="max-w-sm w-full bg-gray-800/90 backdrop-blur-md shadow-lg rounded-lg p-6 space-y-6 mx-auto mt-20">
    <div class="text-center">
      <img src="logo.png" alt="NUUR Logo" class="mx-auto h-16 w-16 mb-4"/>
      <h1 class="text-3xl font-extrabold tracking-wide">NUUR Token Presale</h1>
      <p class="text-sm text-gray-300 mt-2">1 NUUR = 0.001 SDA | 1000 NUUR per SDA</p>
    </div>

    <div class="text-center">
      <p class="text-base text-gray-200 font-medium">Remaining NUUR available for purchase:</p>
      <p id="contractBalance" class="text-xl font-bold text-yellow-400 mt-2">Loading...</p>
    </div>

    <div class="text-center">
      <p class="text-base text-gray-200 font-medium">Your Wallet Balance:</p>
      <p id="walletBalance" class="text-xl font-bold text-green-400 mt-2">Not Connected</p>
    </div>

    <div>
      <label for="sdaAmount" class="block text-sm font-medium mb-2">Enter SDA Amount:</label>
      <input id="sdaAmount" type="number" min="0.001" max="5000" step="0.001" placeholder="e.g. 10"
             class="w-full px-4 py-3 text-sm rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
      <p class="mt-2 text-sm text-gray-300">You'll receive <span id="nuurEstimate" class="font-semibold text-yellow-400">0</span> NUUR</p>
    </div>

    <div class="flex flex-col space-y-4">
      <button onclick="buyTokens()"
              class="w-full px-6 py-3 bg-green-600 text-white rounded-lg text-sm font-semibold shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transition">
        Buy NUUR
      </button>
    </div>

    <div id="statusMessage" class="text-sm text-center mt-4 text-yellow-400"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
<script>
  let provider, signer, userAddress;
  const presaleAddress = "0x858024C3c8179Ed448A9133190f991cfA9873657";
  const rate = 1000;

  const abi = [{"inputs":[{"internalType":"address","name":"_nuurToken","type":"address"},{"internalType":"address","name":"_devWallet","type":"address"},{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"NUURWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"SDAWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"sdaAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nuurAmount","type":"uint256"}],"name":"TokensPurchased","type":"event"},{"inputs":[],"name":"RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyTokens","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"devWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nuurToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newDevWallet","type":"address"}],"name":"updateDevWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawNUUR","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawSDA","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

  document.addEventListener("DOMContentLoaded", () => {
    const sdaInput = document.getElementById("sdaAmount");
    const nuurEstimate = document.getElementById("nuurEstimate");

    if (sdaInput && nuurEstimate) {
      sdaInput.addEventListener("input", () => {
        const sdaValue = parseFloat(sdaInput.value) || 0;
        nuurEstimate.innerText = (sdaValue * rate).toLocaleString();
      });
    }

    // Try auto-connect if MetaMask already connected
    if (window.ethereum?.selectedAddress) {
      connectWallet();
    }
  });

  async function connectWallet() {
    if (!window.ethereum) {
      alert("Please install MetaMask!");
      return;
    }

    try {
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      userAddress = await signer.getAddress();

      document.getElementById("statusMessage").innerText =
        `Wallet Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
      document.getElementById("connectWalletButton").style.display = "none";
      document.getElementById("disconnectWalletButton").style.display = "inline-block";

      await showWalletBalance();
      await showContractBalance();
    } catch (err) {
      console.error("Connection error:", err);
      document.getElementById("statusMessage").innerText = "Wallet connection failed.";
    }
  }

  function disconnectWallet() {
    userAddress = null;
    provider = null;
    signer = null;

    document.getElementById("statusMessage").innerText = "Wallet disconnected.";
    document.getElementById("connectWalletButton").style.display = "inline-block";
    document.getElementById("disconnectWalletButton").style.display = "none";
    document.getElementById("walletBalance").innerText = "Not Connected";
    document.getElementById("contractBalance").innerText = "Loading...";
  }

  async function showWalletBalance() {
    if (!provider || !userAddress) return;

    try {
      const balance = await provider.getBalance(userAddress);
      const formatted = ethers.formatEther(balance);
      document.getElementById("walletBalance").innerText = `${parseFloat(formatted).toFixed(4)} SDA`;
    } catch (err) {
      console.error("Failed to fetch wallet balance:", err);
      document.getElementById("walletBalance").innerText = "Unavailable";
    }
  }

  async function showContractBalance() {
    try {
      const contract = new ethers.Contract(presaleAddress, abi, provider);
      const nuurTokenAddress = await contract.nuurToken();
      const nuurToken = new ethers.Contract(
        nuurTokenAddress,
        [
          "function balanceOf(address owner) view returns (uint256)"
        ],
        provider
      );

      const balance = await nuurToken.balanceOf(presaleAddress);
      const formatted = ethers.formatUnits(balance, 18);
      document.getElementById("contractBalance").innerText = `${parseFloat(formatted).toLocaleString()} NUUR`;
    } catch (err) {
      console.error("Failed to fetch contract balance:", err);
      document.getElementById("contractBalance").innerText = "Unavailable";
    }
  }
  async function buyTokens() {
  const sdaInput = document.getElementById("sdaAmount");
  const status = document.getElementById("statusMessage");

  if (!signer || !provider || !userAddress) {
    status.innerText = "Please connect your wallet first.";
    return;
  }

  const sdaAmount = parseFloat(sdaInput.value);
  if (isNaN(sdaAmount) || sdaAmount <= 0) {
    status.innerText = "Enter a valid SDA amount.";
    return;
  }

  try {
    const valueInWei = ethers.parseEther(sdaAmount.toString());
    const contract = new ethers.Contract(presaleAddress, abi, signer);
    const tx = await contract.buyTokens({ value: valueInWei });

    status.innerText = "⏳ Waiting for transaction confirmation...";
    const receipt = await tx.wait();

    const explorerLink = `https://ledger.sidrachain.com/tx/${receipt.hash}`;
    status.innerHTML = `✅ Transaction confirmed. <a href="${explorerLink}" target="_blank" class="underline text-green-300">View on Explorer</a>`;

    await showWalletBalance();
    await showContractBalance();
  } catch (err) {
    console.error("Transaction error:", err);
    status.innerText = err.reason || "❌ Transaction failed or rejected.";
  }
}

</script>
</body>
</html>
